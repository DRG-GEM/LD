<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Control de Asistencia del Equipo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .modal { transition: opacity 0.25s ease; }
        .modal-content { transition: transform 0.25s ease; }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div id="app" class="container mx-auto p-4 md:p-6 max-w-4xl">

        <!-- Vista del Jugador (Check-in con reconocimiento) -->
        <div id="player-view" class="hidden">
            <div class="bg-white p-6 md:p-8 rounded-xl shadow-lg text-center">
                
                <!-- Paso 1: Identificación inicial (si es necesario) -->
                <div id="player-identification-step">
                    <h1 class="text-2xl md:text-3xl font-bold text-indigo-600">Identifícate por primera vez</h1>
                    <p class="text-gray-500 mt-2">Selecciona tu nombre. Solo tendrás que hacer esto una vez.</p>
                    <div class="mt-8 text-left">
                        <label for="player-select" class="block text-sm font-medium text-gray-700 mb-1">Nombre del Jugador</label>
                        <select id="player-select" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition">
                            <option value="">-- Cargando plantilla... --</option>
                        </select>
                        <button id="confirm-identity-button" class="mt-4 w-full bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-transform transform hover:scale-105">
                            Confirmar y Registrar Llegada
                        </button>
                    </div>
                </div>

                <!-- Paso 2: Registro automático -->
                <div id="player-checkin-step" class="hidden">
                    <div id="loading-view">
                        <h1 class="text-2xl font-bold text-indigo-600">Registrando tu llegada...</h1>
                        <p id="loading-event-name" class="text-gray-500 mt-2"></p>
                        <div class="mt-6 flex justify-center items-center">
                            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-600"></div>
                        </div>
                    </div>
                    <div id="result-view" class="hidden">
                         <h1 id="player-greeting" class="text-2xl md:text-3xl font-bold"></h1>
                         <p id="player-message" class="text-gray-600 mt-2 text-lg"></p>
                         <div class="mt-6">
                            <button id="reset-identity-button" class="text-sm text-indigo-600 hover:text-indigo-800 hover:underline">¿No eres tú? Cambiar de jugador</button>
                         </div>
                    </div>
                </div>

            </div>
        </div>

        <!-- Vista del Entrenador (Admin) -->
        <div id="coach-view" class="hidden">
            <header class="mb-8">
                <h1 class="text-3xl md:text-4xl font-bold text-gray-900">Panel de Control del Equipo</h1>
                <p class="text-gray-600 mt-1">Gestiona la plantilla, crea citaciones y genera el QR del partido.</p>
            </header>

            <!-- Sección de Plantilla -->
            <div class="bg-white p-6 rounded-xl shadow-md mb-6">
                <h2 class="text-xl font-bold mb-4 flex items-center">
                    <svg class="w-6 h-6 mr-2 text-indigo-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>
                    Plantilla del Equipo
                </h2>
                <p class="text-sm text-gray-500 mb-3">Introduce los nombres de los jugadores, uno por línea. Esta es la lista que verán para identificarse la primera vez.</p>
                <textarea id="player-roster" class="w-full h-40 p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500" placeholder="Juan Pérez&#10;Marcos García&#10;..."></textarea>
                <button id="save-roster-button" class="mt-4 bg-indigo-600 text-white font-bold py-2 px-5 rounded-lg hover:bg-indigo-700 transition">
                    Guardar Plantilla
                </button>
                <p id="roster-status" class="text-sm mt-2 text-green-600"></p>
            </div>

            <!-- Sección de Citaciones -->
            <div class="bg-white p-6 rounded-xl shadow-md">
                <h2 class="text-xl font-bold mb-4 flex items-center">
                     <svg class="w-6 h-6 mr-2 text-indigo-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                    Citaciones
                </h2>
                <div class="flex flex-col sm:flex-row gap-3">
                    <input type="text" id="event-name" class="flex-grow p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500" placeholder="Ej: Partido vs. Equipo Rival">
                    <button id="create-event-button" class="bg-green-500 text-white font-bold py-3 px-6 rounded-lg hover:bg-green-600 transition">
                        Crear Citación
                    </button>
                </div>

                <div id="events-list" class="mt-6 space-y-4">
                    <!-- Las citaciones se cargarán aquí -->
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para QR -->
    <div id="qr-modal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden opacity-0">
        <div class="modal-content bg-white p-6 rounded-2xl shadow-2xl w-full max-w-sm text-center transform scale-95">
            <h3 id="qr-modal-title" class="text-xl font-bold mb-4"></h3>
            <div id="qrcode-container" class="flex justify-center p-4 bg-gray-50 rounded-lg"></div>
            <p class="text-sm text-gray-600 mt-4">Coloca este QR en el autobús. Es único para esta citación.</p>
            <button id="close-modal-button" class="mt-6 w-full bg-gray-200 text-gray-800 font-bold py-2 px-4 rounded-lg hover:bg-gray-300 transition">Cerrar</button>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, doc, setDoc, getDoc, addDoc, collection, onSnapshot, query, serverTimestamp, where, getDocs, limit } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : { apiKey: "YOUR_API_KEY", authDomain: "YOUR_AUTH_DOMAIN", projectId: "YOUR_PROJECT_ID" };
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-checkin-app-v3';

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        document.addEventListener('DOMContentLoaded', async () => {
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) { console.error("Auth Error:", error); }
            
            const urlParams = new URLSearchParams(window.location.search);
            const eventId = urlParams.get('event');

            if (eventId) {
                document.getElementById('coach-view').classList.add('hidden');
                document.getElementById('player-view').classList.remove('hidden');
                initPlayerView(eventId);
            } else {
                document.getElementById('player-view').classList.add('hidden');
                document.getElementById('coach-view').classList.remove('hidden');
                initCoachView();
            }
        });

        // --- VISTA DEL ENTRENADOR ---
        function initCoachView() {
            const rosterTextarea = document.getElementById('player-roster');
            const saveRosterBtn = document.getElementById('save-roster-button');
            const rosterStatus = document.getElementById('roster-status');
            const createEventBtn = document.getElementById('create-event-button');
            const eventNameInput = document.getElementById('event-name');
            const eventsListDiv = document.getElementById('events-list');
            const rosterDocRef = doc(db, `artifacts/${appId}/public/data/roster/main`);

            getDoc(rosterDocRef).then(docSnap => {
                if (docSnap.exists()) rosterTextarea.value = docSnap.data().players.join('\n');
            });

            saveRosterBtn.addEventListener('click', async () => {
                const players = rosterTextarea.value.split('\n').map(p => p.trim()).filter(p => p);
                try {
                    await setDoc(rosterDocRef, { players });
                    rosterStatus.textContent = '¡Plantilla guardada!';
                    setTimeout(() => rosterStatus.textContent = '', 3000);
                } catch (e) { console.error(e); }
            });

            createEventBtn.addEventListener('click', async () => {
                const eventName = eventNameInput.value.trim();
                if (!eventName) return;
                try {
                    await addDoc(collection(db, `artifacts/${appId}/public/data/events`), {
                        name: eventName,
                        createdAt: serverTimestamp()
                    });
                    eventNameInput.value = '';
                } catch (e) { console.error(e); }
            });

            const q = query(collection(db, `artifacts/${appId}/public/data/events`));
            onSnapshot(q, (snapshot) => {
                if (snapshot.empty) {
                    eventsListDiv.innerHTML = '<p class="text-center text-gray-500 p-4 border-2 border-dashed rounded-lg">Aún no has creado ninguna citación.</p>';
                    return;
                }
                const events = [];
                snapshot.forEach(doc => events.push({ id: doc.id, ...doc.data() }));
                events.sort((a, b) => (b.createdAt?.toMillis() || 0) - (a.createdAt?.toMillis() || 0));
                
                eventsListDiv.innerHTML = '';
                events.forEach(event => {
                    const eventEl = document.createElement('div');
                    eventEl.className = 'bg-gray-50 p-4 rounded-lg border border-gray-200';
                    eventEl.innerHTML = `
                        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center">
                            <div>
                                <h3 class="font-bold text-lg">${event.name}</h3>
                                <p class="text-sm text-gray-500">${event.createdAt ? new Date(event.createdAt.seconds * 1000).toLocaleString('es-ES') : ''}</p>
                            </div>
                            <div class="flex gap-2 mt-3 sm:mt-0">
                                <button data-event-id="${event.id}" data-event-name="${event.name}" class="show-qr-btn bg-blue-500 text-white text-sm font-semibold py-2 px-4 rounded-lg hover:bg-blue-600 transition">Ver QR</button>
                                <button data-event-id="${event.id}" class="toggle-checkins-btn bg-gray-600 text-white text-sm font-semibold py-2 px-4 rounded-lg hover:bg-gray-700 transition">Ver Registros</button>
                            </div>
                        </div>
                        <div id="checkins-${event.id}" class="hidden mt-4 pt-4 border-t border-gray-200"></div>`;
                    eventsListDiv.appendChild(eventEl);
                });
            });
            
            eventsListDiv.addEventListener('click', (e) => {
                if (e.target.classList.contains('show-qr-btn')) {
                    showQrModal(e.target.dataset.eventId, e.target.dataset.eventName);
                }
                if (e.target.classList.contains('toggle-checkins-btn')) {
                    toggleCheckinsView(e.target.dataset.eventId, e.target);
                }
            });
        }
        
        function showQrModal(eventId, eventName) {
            const modal = document.getElementById('qr-modal');
            const modalTitle = document.getElementById('qr-modal-title');
            const qrContainer = document.getElementById('qrcode-container');
            const closeModalBtn = document.getElementById('close-modal-button');
            const url = `${window.location.origin}${window.location.pathname}?event=${eventId}`;
            
            modalTitle.textContent = `QR para: ${eventName}`;
            qrContainer.innerHTML = '';
            new QRCode(qrContainer, { text: url, width: 256, height: 256 });

            modal.classList.remove('hidden');
            setTimeout(() => {
                modal.classList.remove('opacity-0');
                modal.querySelector('.modal-content').classList.remove('scale-95');
            }, 10);
            closeModalBtn.onclick = () => {
                 modal.classList.add('opacity-0');
                 modal.querySelector('.modal-content').classList.add('scale-95');
                 setTimeout(() => modal.classList.add('hidden'), 250);
            };
        }

        function toggleCheckinsView(eventId, button) {
            const checkinsDiv = document.getElementById(`checkins-${eventId}`);
            const isHidden = checkinsDiv.classList.contains('hidden');
            button.textContent = isHidden ? 'Ocultar Registros' : 'Ver Registros';
            button.classList.toggle('bg-gray-600', !isHidden);
            button.classList.toggle('bg-red-500', isHidden);
            checkinsDiv.classList.toggle('hidden');
            if (isHidden) loadCheckins(eventId);
        }

        function loadCheckins(eventId) {
            const checkinsDiv = document.getElementById(`checkins-${eventId}`);
            checkinsDiv.innerHTML = '<p class="text-gray-500">Cargando...</p>';
            const q = query(collection(db, `artifacts/${appId}/public/data/events/${eventId}/checkins`));
            onSnapshot(q, (snapshot) => {
                if (snapshot.empty) {
                    checkinsDiv.innerHTML = '<p class="text-center text-gray-500">Nadie ha registrado su llegada.</p>';
                    return;
                }
                let checkins = [];
                snapshot.forEach(doc => checkins.push(doc.data()));
                checkins.sort((a,b) => (a.checkinTime?.toMillis() || 0) - (b.checkinTime?.toMillis() || 0));
                let tableHTML = `<table class="w-full text-sm text-left text-gray-500"><thead class="text-xs text-gray-700 uppercase bg-gray-100"><tr><th scope="col" class="px-6 py-3">Jugador</th><th scope="col" class="px-6 py-3">Hora</th></tr></thead><tbody>`;
                checkins.forEach(c => {
                    tableHTML += `<tr class="bg-white border-b"><td class="px-6 py-4 font-medium text-gray-900">${c.playerName}</td><td class="px-6 py-4">${new Date(c.checkinTime.seconds * 1000).toLocaleTimeString('es-ES')}</td></tr>`;
                });
                checkinsDiv.innerHTML = tableHTML + '</tbody></table>';
            });
        }

        // --- VISTA DEL JUGADOR ---
        async function initPlayerView(eventId) {
            const playerProfile = JSON.parse(localStorage.getItem('playerProfile'));
            
            // *** NUEVA LÓGICA DE RESETEO ***
            document.getElementById('reset-identity-button').addEventListener('click', () => {
                localStorage.removeItem('playerProfile');
                window.location.reload();
            });

            if (playerProfile && playerProfile.name) {
                // Ya está identificado, registrar llegada directamente
                document.getElementById('player-identification-step').classList.add('hidden');
                document.getElementById('player-checkin-step').classList.remove('hidden');
                await registerCheckin(eventId, playerProfile.name);
            } else {
                // Necesita identificarse por primera vez
                document.getElementById('player-identification-step').classList.remove('hidden');
                document.getElementById('player-checkin-step').classList.add('hidden');
                await setupIdentification(eventId);
            }
        }

        async function setupIdentification(eventId) {
            const playerSelect = document.getElementById('player-select');
            const confirmBtn = document.getElementById('confirm-identity-button');
            
            // Cargar la plantilla para el desplegable
            const rosterDocRef = doc(db, `artifacts/${appId}/public/data/roster/main`);
            const rosterDoc = await getDoc(rosterDocRef);
            if (rosterDoc.exists()) {
                const players = rosterDoc.data().players || [];
                playerSelect.innerHTML = '<option value="">-- Selecciona tu nombre --</option>';
                
                // *** MEJORA: Validar que el jugador guardado sigue en la plantilla ***
                const storedProfile = JSON.parse(localStorage.getItem('playerProfile'));
                if (storedProfile && !players.includes(storedProfile.name)) {
                    localStorage.removeItem('playerProfile'); // Limpiar si el jugador ya no está
                }

                players.forEach(player => {
                    const option = document.createElement('option');
                    option.value = player;
                    option.textContent = player;
                    playerSelect.appendChild(option);
                });
            }

            confirmBtn.addEventListener('click', async () => {
                const selectedPlayer = playerSelect.value;
                if (!selectedPlayer) {
                    alert('Debes seleccionar tu nombre.');
                    return;
                }
                
                // Guardar perfil en el dispositivo del jugador
                const profile = { name: selectedPlayer };
                localStorage.setItem('playerProfile', JSON.stringify(profile));

                // Ocultar identificación y proceder al registro
                document.getElementById('player-identification-step').classList.add('hidden');
                document.getElementById('player-checkin-step').classList.remove('hidden');
                await registerCheckin(eventId, selectedPlayer);
            });
        }

        async function registerCheckin(eventId, playerName) {
            const loadingView = document.getElementById('loading-view');
            const resultView = document.getElementById('result-view');
            const greetingEl = document.getElementById('player-greeting');
            const messageEl = document.getElementById('player-message');
            const eventNameEl = document.getElementById('loading-event-name');

            try {
                // Obtener nombre del evento para mostrarlo
                const eventDoc = await getDoc(doc(db, `artifacts/${appId}/public/data/events/${eventId}`));
                const eventName = eventDoc.exists() ? eventDoc.data().name : "un evento";
                eventNameEl.textContent = `Para: ${eventName}`;

                // Comprobar si ya ha fichado para este evento
                const checkinRef = collection(db, `artifacts/${appId}/public/data/events/${eventId}/checkins`);
                const qCheckin = query(checkinRef, where("playerName", "==", playerName), limit(1));
                const existingCheckinSnap = await getDocs(qCheckin);

                if (!existingCheckinSnap.empty) {
                    const existingData = existingCheckinSnap.docs[0].data();
                    const time = new Date(existingData.checkinTime.seconds * 1000).toLocaleTimeString('es-ES');
                    greetingEl.textContent = `¡Hola de nuevo, ${playerName}!`;
                    messageEl.textContent = `Ya habías registrado tu llegada para "${eventName}" a las ${time}.`;
                } else {
                    // Registrar la llegada
                    await addDoc(checkinRef, {
                        playerName: playerName,
                        checkinTime: serverTimestamp()
                    });
                    greetingEl.textContent = `✅ ¡Bienvenido, ${playerName}!`;
                    messageEl.textContent = `Tu llegada para "${eventName}" ha sido registrada.`;
                }

            } catch (error) {
                console.error("Checkin Error:", error);
                greetingEl.textContent = '❌ Error';
                messageEl.textContent = "No se pudo completar el registro. Contacta con el cuerpo técnico.";
            } finally {
                loadingView.classList.add('hidden');
                resultView.classList.remove('hidden');
            }
        }

    </script>
</body>
</html>
